---
title: "3η εργασία στατιστική μοντελοποίηση - ΔΠΜΣ ΕΔΕΜΜ"
author: "Δημήτρης Ζερκελίδης - 03400049"
date: "Άσκηση 1 ~ Poisson"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Προσαρμογή του μοντέλου μας με τη χρήση της παλινδρόμησης Poisson. Παρατηρούμε πως έχουμε επεξεργαστεί τη μεταβλητη n την οποία μετατρέψαμε σε offset(log(n)). To n δηλώνει το πλήθος των συμβολαίων. Η χρήση του offset γίνεται για να είναι όλα στην ίδια μονάδα μέτρησης και να μπορούμε να μετράμε το rate(αριθμός αποζημιώσεων ανά συμβόλαιο) ενώ το log, λόγω του ότι έτσι μοντελοποιείται η συνάρτηση poisson εφόσον έχει link function τη λογαριθμική.


```{r}
file1 <- read.table("/home/zerkes/Desktop/DSML - MASTER/1st semester/STATISTICAL MODELLING/project3/final/asfalies.txt", header=TRUE)
attach(file1)
library(MASS)
library(car)
car_cat <- factor(cartype)
mod_full <- glm(y ~ agecat + car_cat + district + offset(log(n)), family=poisson, data=file1)
summary(mod_full)
```

Aπό το παραπάνω summary μπορούμε να δούμε πως όλες οι μεταβλητές μας είναι στατιστικά σημαντικές σύμφωνα με το wald test.Επομένως, οι μεταβλητές αυτές όντως σχετίζονται με τον αριθμό Υ των αποζημιώσεων.

Στον παρακάτω πίνακα μπορούμε να δούμε, όπως και στο summary προηγουμένως, πως όλες οι μεταβλητές είναι στατιστικά σημαντικές και βοηθάνε στην επεξήγηση της εξαρτημένης μεταβλητής.Επιπρόσθετα, μπορούμε να δούμε πως κάθε μεταβλητή συνεισφέρει, στη βελτίωση της Deviance σε σχέση με το null model. Στο Deviance Resid. φαίνεται το πόσο η συγκεκριμένη μεταβλητή μειώνει την ελεγχοσυνάρτηση Deviance όταν εισάγεται ,ενώ στη στήλη Dev. φαίνεται το υπόλοιπο του συνολικού Deviance σε σχέση με το saturated μοντέλο.

Γενικά, η ελεγχοσυνάρτηση Deviance μετράει την απώλεια προσαρμογής σε σχέση με το saturated(κορεσμένο - πλήρες) μοντέλο το οποίο έχει ένα συντελεστή για κάθε δείγμα.

```{r}
anova(mod_full, test = "Chisq")
```

Από τα παραπάνω βλέπουμε πως η μεταβλητή car_cat επιφέρει τη μεγαλύτερη βελτίωση στο μοντέλο καθώς μειώνει κατα 90.925 το Deviance της συνάρτησης όταν αυτή περιέχει το agecat μόνο σα μεταβλητή.


**BACKWARD STEPWISE SELECTION MODEL** 

θα εξετάσουμε το αν πρέπει να αφαιρέσουμε μεταβλητές από το μοντέλο μας με τη χρήση backward stepwise selection και wald tests.

```{r}
m1 = step(mod_full, direction="backward", test="Chisq")
summary(m1)
```

Παρατηρούμε πως το μοντέλο με όλες τις μεταβλητές είναι το καταλληλότερο σύμφωνα με τον backward αλγόριθμο, με κριτήρio AIC = 222.15.


**ΔΙΑΓΡΑΜΜΑ ΡΥΘΜΟΥ ΑΠΟΖΗΜΙΩΣΕΩΝ Υ ~ ΚΑΤΗΓΟΡΙΑΣ ΗΛΙΚΙΩΝ**
```{r}
plot(agecat,y/n,pch=19)
```

**ΔΙΑΓΡΑΜΜΑ ΡΥΘΜΟΥ ΑΠΟΖΗΜΙΩΣΕΩΝ Υ ~ ΚΑΤΗΓΟΡΙΑΣ ΑΥΤΟΚΙΝΗΤΩΝ**
```{r}
plot(car_cat,y/n,pch=19)
```

Στο παραπάνω διάγραμμα φαίνεται πως όσο ανεβαίνει το επίπεδο στην κατηγορία αμαξιών, ανεβαίνει παράλληλα και η median τιμή των αποζημιώσεων. Επίσης στο 4ο επίπεδο, φαίνεται να υπάρχουν αρκετά outliers ειδικά στο 1ο quantile σε σχέση με τα υπόλοιπα επίπεδα.

**ΔΙΑΓΡΑΜΜΑ ΡΥΘΜΟΥ ΑΠΟΖΗΜΙΩΣΕΩΝ Υ ~ EΠΑΡΧΙΑ/ΠΟΛΗ**
```{r}
plot(district,y/n,pch=19)
```

**ΈΛΕΓΧΟΣ DEVIANCE ΓΙΑ ΤΟ ΕΠΙΛΕΓΜΕΝΟ ΜΟΝΤΕΛΟ**

Παρακάτω θα κάνουμε χρήση της ελεγχοσυνάρτησης Deviance η οποία ακολουθεί την κατανομή Chi-square για να συγκρίνουμε την απώλεια που έχει το επιλεγμένο μοντέλο από το κορεσμένο (saturated) μοντέλο.

```{r}
pvalue <-  1 - pchisq(mod_full$deviance,mod_full$df.residual)
pvalue
```

To παραπάνω έχει βαθμούς ελευθερίας 32-26 = 6 και η τιμή p δεν είναι ικανοποιητική, ωστόσο ο συγκεκριμένος έλεγχος δεν είναι τόσο αξιόπιστος όταν πρόκειται για σύγκριση με το saturated μοντέλο αλλά είναι πιο αξιόπιστο όταν γίνεται με βάση 2 άλλα μοντέλα. Γενικά, το μοντέλο μας εξηγεί τη μεταβλητή y καλά.

**ΔΙΑΓΝΩΣΤΙΚΟΙ ΕΛΕΓΧΟΙ ~ ΠΡΟΣΑΡΜΟΓΗΣ ~ ΑΤΥΠΩΝ ΣΗΜΕΙΩΝ**

Τα υπόλοιπα χρησιμοποιούνται για να ελέγξουμε την καταλληλότητα του μοντέλου μέσα από γραφικές παραστάσεις. Αρχικά, έχουμε τα index plots των διαφόρων τύπων  υπολοίπων ως προς τη σειρά παρατηρήσεων. Η παρουσία μεγάλων ασυνήθιστα υπολοίπων δείχνει ότι το μοντέλο μας δεν είναι ικανοποιητικό.

Επιπλέον, υπάρχουν γραφικές παραστάσεις υπολοίπων έναντι κάθε συμμεταβλητής η του linear predictor (X'β) που μπορούν να αποβούν πολύ χρήσιμες στην εξέταση,ώστε είτε να συμπεριλάβουμε νέες μεταβλητές , είτε να μετασχηματιστεί μια υπάρχουσα. Κάποιο συστηματικό σχήμα δείχνει την πιθανή ύπαρξη προβλήματος στο μοντέλο.

Όλες αυτές οι γραφικές παραστάσεις συμβάλουν στον εντοπισμό των outliers.

Tέλος, υπάρχει και ο έλεγχος των υπολοίπων αν ακολουθούν την κανονική κατανομή για να δείξουμε πόσο καλά έχει προσαρμοστεί το μοντέλο και όχι σαν ένδειξη κανονικότητας των υπολοίπων. Τιμές που ξεφεύγουν από την ευθεία υποδεικνύουν πιθανή μη καλή προσαρμογή του μοντέλου.

Στον παρακάτω κώδικα υπολογίζουμε τα τυποποιημένα σφάλματα pearson, deviance , likelihood.

```{r}

res_pearson <- residuals(mod_full, type = "pearson")
standard_pearson_residuals <- res_pearson/(sqrt(1-hatvalues(mod_full)))

res_deviance <- residuals(mod_full, type = "deviance")
standard_res_deviance <- rstandard(mod_full)

res_lik <- sign(y - fitted.values(mod_full))*sqrt(hatvalues(mod_full)*standard_pearson_residuals^2 + (1-
hatvalues(mod_full))*standard_res_deviance^2)
```

*INDEX PLOTS*

```{r}
plot(standard_pearson_residuals, main='Index plot ~Standarised Pearson res.', xlab = 'index', ylab = 'Standarised Pearson Residuals')
plot(standard_res_deviance, main='Index plot ~Standarised Dev res.', xlab = 'index', ylab = 'Standarised Deviance Residuals')
plot(res_lik , main='Index plot ~ Res. Lik.', xlab = 'index', ylab = 'Residuals Likelihood')
```
Από τα παραπάνω index-plots φαίνεται η ύπαρξη μεγάλων υπολοίπων, πράγμα που σημαίνει πως έχουμε κάποια άτυπα σημεία.

*QQ NORMAL PLOTS*
Από το διάγραμμα NORMAL Q-Q PLOT βλέπουμε πως αρκετά σημεία ξεφεύγουν από την ευθεία, το οποίο και αυτό με τη σειρά του μας υποδεικνύει την ύπαρξη άτυπων σημείων.

```{r}
qqnorm(standard_pearson_residuals)
qqline(standard_pearson_residuals)

qqnorm(res_deviance/sqrt((1-hatvalues(mod_full))))
qqline(res_deviance/sqrt((1-hatvalues(mod_full))))
```

*PLOTS RESIDUALS ~ COVARIATES AND LINEAR PREDICTOR(FITTED VALUES)*


```{r}
plot(fitted.values(mod_full), res_deviance/sqrt((1-hatvalues(mod_full))), ylab = "ΤΥΠΟΠΟΙΗΜΕΝΟ ΣΦΑΛΜΑ DEVIANCE")
abline(h=0)

residualPlots(mod_full)
```
Από τα γραφήματα residuals~agecat και residuals~district παίρνουμε κάποια πολύ καλά αποτελέσματα καθώς δεν παρατηρείται κάποια συστηματικότητα και παίρνουμε μια ευθεία γραμμή.

Το γράφημα που περιέχει τις κατηγορίες αμαξιών βλέπουμε πως όσο ανεβαίνουμε κατηγορία ο μέσος ανεβαίνει κατά μέσο όρο. Ενώ επίσης στα 1α και 4α τεταρτημόρια έχουν μεγάλες διαφορές ως προς τη διασπορά τους. Είναι εμφανές πως έχουμε πάλι κάποια outliers.

Τέλος το γράφημα του linear predictor είναι εμφανές πως δεν σκεδάζεται τυχαία αλλά έχουν μια συγκέντρωση προς το κέντρο ενώ εν συνεχεία στο τελευταίο γράφημα βλέπουμε πως πάνε κυρίως κάτω από το 0 οι τιμές.

**CR PLOTS**

*CR PLOTS*

Από τα παρακάτω διαγράμματα βλέπουμε πως οι μεταβλητές μας έχουν μια καλή γραμμικότητα, ενώ θα ήταν δύσκολο να μετασχηματιστούνε εφόσον είναι binary τιμές για να βελτιώσουμε τη γραμμικότητα τους.

```{r}

crPlot(mod_full, variable=agecat, pch=19)
crPlot(mod_full, variable=district, pch=19)

```

**ΕΞΕΤΑΣΗ ΣΗΜΕΙΩΝ ΕΠΙΡΡΟΗΣ**

Στα πρώτα 2 διαγράμματα παρατηρούμε την ύπαρξη κάποιων άτυπων σημείων. Πιο αναλυτικά
στο διάγραμμα με τις αποστάσεις Cook παρατηρούμε ότι η παρατήρηση 12 έχει cooks distance
μεγαλύτερο του 1.

Όσον αφορά την μόχλευση ύποπτα θεωρούνται σημεία με τιμή μεγαλύτερη
της 2p/n = 0.1875 και παρατηρούμε ότι υπάρχουν αρκετά τέτοια σημεία για παράδειγμα είναι οι
παρατηρήσεις 4, 8, 12, 16 και 24.


```{r}
id = c(1:32) # arithmos paratirisewn

#διάγραμμα υπολοίπων πιθανοφάνειας ως προς hii
plot(hatvalues(mod_full),res_lik)
abline(h=0)

#διάγραμμα residual likelihood vs id
plot(id,res_lik,ylab = "res_Lik")
abline(h=0)

#cooks distance 
plot(id,cooks.distance(mod_full))

#hat values
plot(id,hatvalues(mod_full))
```

Συγκεκριμένα τα άτυπα σημεία φαίνονται παρακάτω:
```{r}
cooks.distance(mod_full)[which(cooks.distance(mod_full)>1)]

hatvalues(mod_full)[which(hatvalues(mod_full)> 0.1875)]

```

Συμπερασματικά, το μοντέλο ίσως φαίνεται αδύναμο σε σχέση με το κορεσμένο λόγω αρκετών άτυπων σημείων. Aν αφαιρέσουμε αυτά τα άτυπα σημεία και ξανά κάνουμε fit το μοντέλο μας, τότε σίγουρα θα βελτιωθεί αρκετά η προγνωστική του ικανότητα.

**DEVIANCE R SQUARED**

Παρακάτω φαίνεται ο συντελεστής προσδιορισμού ότι λαμβάνει την τιμή 0,79. Ο συγκεκριμένος αριθμός είναι από 0 εώς 1 και μας δείχνει το ποσοστό της μεταβλητότητας που εξηγείται από το συστηματικό μέρος του μοντέλου.

```{r}
1 - (mod_full$deviance / mod_full$null.deviance)
```

Μπορούμε να δούμε το συντελεστή αυτόν αν αφαιρέσουμε τα άτυπα σημεία κατά πόσο θα βελτιωθεί.

```{r}
file2 <- read.table("/home/zerkes/Desktop/DSML - MASTER/1st semester/STATISTICAL MODELLING/project3/final/asfalies_outliers.txt", header=TRUE)
attach(file2)
car_cat <- factor(cartype)
mod_no_outliers <- glm(y ~ agecat + car_cat + district + offset(log(n)), family=poisson, data=file2)


1 - (mod_no_outliers$deviance / mod_no_outliers$null.deviance)
```

Παρατηρούμε πως αφαιρώντας τα outliers η προγνωστική ικανότητα του μοντέλου βελτιώθηκε.


**ΕΡΜΗΝΕΙΑ ΣΥΝΤΕΛΕΣΤΩΝ ΤΟΥ ΕΠΙΛΕΓΜΕΝΟΥ ΜΑΣ ΜΟΝΤΕΛΟΥ**

*agecat coefficient: −0.37628* 
  Ο συντελεστής της κατηγορίας ηλικίας είναι αρνητικός, γεγονός που δείχνει ότι όσο αυξάνεται η ηλικία μειώνεται ο αριθμός των αποζημιώσεων λόγω τροχαίων ατυχημάτων.Ουσιαστικά, αν έχουμε σταθερές όλες τις άλλες μεταβλητές, ο αριθμός των αποζημιώσεων για την ηλικιακή κατηγορία 1 είναι 0.686.. φορές ο αντίστοιχος της κατηγορίας 0 .Αυτό σημαίνει ότι όταν από την κατηγορία 0 που είναι οι μικρότερες ηλικίες μεταβούμε στην κατηγορία 1 που είναι οι μεγαλύτερες, η μεταβλητή των αποζημιώσεων πολλαπλασιάζεται με το e^-0.37.. που σημαίνει πως η μεταβλητή y ελαττώνεται.

*district coefficient:είναι 0.21661*
  O συντελεστής της κατηγορίας για τις περιοχές είναι θετικός που σημαίνει ότι λειτουργεί αυξητικά στην εξαρτημένη μεταβλητή μας όταν μεταβαίνουμε από την επαρχία(0) στην ομάδα με περιοχή την Αθήνα(1). Εν ολίγοις, κρατώντας τις υπόλοιπες μεταβλητές σταθερές, ο αριθμός αποζημιώσεων για την ομάδα στην περιοχή της Αθήνας είναι e^0.21661=1.242 ο αντίστοιχος αριθμός εξαρτημένης μεταβλητής στην άλλη περιοχή.
  
*cartype coefficient ~ κατηγορηματική μεταβλητή - 4 levels - 3 dummy variables:*
  H συγκεκριμένη μεταβλητή μας εξηγείται με τον παρακάτω τρόπο. Θέτει ως σημείο αναφοράς το 1ο επίπεδο ενώ τα άλλα επίπεδα δηλώνουν τη μεταβολή από το επίπεδο αναφοράς(1ο επίπεδο) στο αντίστοιχα δικό τους επίπεδο.
  Παρακάτω φαίνονται οι συντελεστές για το κάθε επίπεδο σε σχέση με το 1ο.
      1->2: 0.16223
      1->3: 1.485
      1->4: 1.760
  Αυτό διαβάζεται για παράδειγμα για το 2ο επίπεδο πως πηγαίνοντας από το 1ο επίπεδο στο 2ο έχουμε exp(0.16223) = 1.176 φορές μεγαλύτερο αριθμό αποζημιώσεων σε σχέση με την 1η κατηγορία κ.ο.κ. Γενικά, βλέπουμε πως όσο ανεβαίνει το επίπεδο ανεβαίνει και το rate  των αριθμών των αποζημιώσεων.
